<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DMI Experiment</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
  }
  #container {
    position: relative;
    display: inline-block;
  }
  #stageCanvas {
    position: absolute;
    top: 0;
    left: 0;
  }
  #stageImage {
    display: block;
  }
  video {
    max-width: 800px;
  }
  #nextBtn {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 16px;
  }
</style>
</head>
<body>
<h1>DMI Experiment</h1>

<div id="container">
  <video id="videoPlayer" controls></video>
  <img id="stageImage" src="stage.png" alt="Stage" style="display:none;">
  <canvas id="stageCanvas"></canvas>
</div>

<br>
<button id="nextBtn">Next</button>

<script>
// --- 設定 ---
const playerID = prompt("Enter your player ID:");
const videos = [
  "A_1_1.mp4",
  "A_1_2.mp4",
  "A_2_1.mp4",
  "A_2_2.mp4"
];

// ランダム順序で並び替え
const videoOrder = [...videos].sort(() => Math.random() - 0.5);
let currentIndex = 0;

// --- 描画関連 ---
const canvas = document.getElementById('stageCanvas');
const ctx = canvas.getContext('2d');
const stageImg = document.getElementById('stageImage');

let drawing = false;
let strokes = []; // 描画データ
let currentStroke = [];

// マウスイベント
canvas.addEventListener('mousedown', e => {
  drawing = true;
  currentStroke = [{x: e.offsetX, y: e.offsetY}];
});
canvas.addEventListener('mousemove', e => {
  if (!drawing) return;
  const point = {x: e.offsetX, y: e.offsetY};
  currentStroke.push(point);
  drawLine(currentStroke);
});
canvas.addEventListener('mouseup', e => {
  if (!drawing) return;
  strokes.push({video: videoOrder[currentIndex], points: currentStroke});
  currentStroke = [];
  drawing = false;
});
canvas.addEventListener('mouseout', e => {
  if (drawing) {
    strokes.push({video: videoOrder[currentIndex], points: currentStroke});
    currentStroke = [];
    drawing = false;
  }
});

function drawLine(points) {
  if (points.length < 2) return;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(stageImg, 0, 0, canvas.width, canvas.height);
  ctx.lineWidth = 2;
  ctx.strokeStyle = 'red';
  ctx.beginPath();
  ctx.moveTo(points[0].x, points[0].y);
  for (let i = 1; i < points.length; i++) {
    ctx.lineTo(points[i].x, points[i].y);
  }
  ctx.stroke();
}

// --- ページ初期化 ---
const videoPlayer = document.getElementById('videoPlayer');
const nextBtn = document.getElementById('nextBtn');

stageImg.onload = () => {
  canvas.width = stageImg.width;
  canvas.height = stageImg.height;
  loadVideo(currentIndex);
};

function loadVideo(index) {
  videoPlayer.src = videoOrder[index];
  videoPlayer.load();
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(stageImg, 0, 0, canvas.width, canvas.height);
}

// --- 次ページ ---
nextBtn.addEventListener('click', () => {
  saveCurrentDrawing();
  currentIndex++;
  if (currentIndex >= videoOrder.length) {
    alert("Experiment finished! Thank you.");
    downloadAllData();
  } else {
    loadVideo(currentIndex);
  }
});

// --- 保存 ---
function saveCurrentDrawing() {
  // 描画はすでに strokes に保存されている
  console.log("Saved strokes for", videoOrder[currentIndex]);
}

function downloadAllData() {
  const data = JSON.stringify({playerID: playerID, strokes: strokes}, null, 2);
  const blob = new Blob([data], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `drawing_data_${playerID}.json`;
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
