<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DMI Experiment</title>
<style>
  body { text-align:center; font-family:sans-serif; }
  #container { position: relative; width: 800px; height: 450px; margin: auto; }
  #stage-img { position: absolute; top:0; left:0; width:100%; height:100%; }
  #stage-canvas { position: absolute; top:0; left:0; width:100%; height:100%; }
  #next-btn { margin-top: 20px; padding: 10px 20px; font-size: 16px; }
</style>
</head>
<body>

<h2>Stage Drawing Experiment</h2>

<div id="container">
    <img id="stage-img" src="stage.png">
    <canvas id="stage-canvas" width="800" height="450"></canvas>
    <video id="video-player" width="800" height="450" style="position:absolute; top:0; left:0;" controls></video>
</div>

<button id="next-btn">Next Video</button>

<script>
const videos = [
    "A_1_1.mp4", // Strong mapping, narrow
    "A_1_2.mp4", // Weak mapping, narrow
    "A_2_1.mp4", // Strong mapping, wide
    "A_2_2.mp4"  // Weak mapping, wide
];

let currentVideoIndex = 0;
let marksAll = []; // 各動画の描画座標をまとめる
let marks = [];    // 現在動画の描画座標

const canvas = document.getElementById('stage-canvas');
const ctx = canvas.getContext('2d');
const video = document.getElementById('video-player');
const nextBtn = document.getElementById('next-btn');

function loadVideo(index){
    marks = []; // 新しい動画で描画座標をリセット
    video.src = videos[index];
    video.load();
}

// --- ペン描画 ---
let drawing = false;
let lastX = 0, lastY = 0;

function getMousePos(e){
    const rect = canvas.getBoundingClientRect();
    if (e.touches) {
        return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
    } else {
        return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }
}

function startDraw(e){
    drawing = true;
    const pos = getMousePos(e);
    lastX = pos.x;
    lastY = pos.y;
    e.preventDefault();
}

function draw(e){
    if (!drawing) return;
    const pos = getMousePos(e);
    ctx.strokeStyle = 'red';
    ctx.lineWidth = 4;
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    marks.push({x: pos.x, y: pos.y});
    lastX = pos.x;
    lastY = pos.y;
    e.preventDefault();
}

function endDraw(e){
    drawing = false;
    e.preventDefault();
}

canvas.addEventListener('mousedown', startDraw);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('mouseup', endDraw);
canvas.addEventListener('mouseout', endDraw);
canvas.addEventListener('touchstart', startDraw);
canvas.addEventListener('touchmove', draw);
canvas.addEventListener('touchend', endDraw);

// --- 次ページボタン ---
nextBtn.addEventListener('click', ()=>{
    marksAll.push(marks); // 現在動画の座標を保存
    currentVideoIndex++;
    if(currentVideoIndex >= videos.length){
        alert("All videos completed! Check console for marks.");
        console.log("All marks:", marksAll);
        nextBtn.disabled = true;
        video.style.display = "none";
        return;
    }
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    loadVideo(currentVideoIndex);
});

loadVideo(currentVideoIndex);

</script>

</body>
</html>
