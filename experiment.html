<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>実験ページ</title>
  <style>
    .container { max-width: 700px; margin: 20px auto; text-align: center; }
    canvas { border: 1px solid #000; cursor: crosshair; display: block; margin: 0 auto; }
    video { margin-bottom: 10px; display: block; margin-left: auto; margin-right: auto; }
  </style>
</head>
<body>
  <div class="container">
    <h2>映像を見て、楽器の位置をマークしてください</h2>

    <!-- 動画 -->
    <video id="stimulus" width="640" controls>
      <source src="stimulus.mp4" type="video/mp4">
      ブラウザがvideoタグをサポートしていません。
    </video>

    <!-- 描画用Canvas -->
    <canvas id="drawCanvas" width="640" height="360"></canvas>

    <button id="saveBtn">描画を保存する</button>
    <p id="status"></p>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getStorage, ref, uploadString } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

    // Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyAjriQxARDTTqfjl5f1UjJ2PiTyG43vbcQ",
      authDomain: "icmcexperiment1.firebaseapp.com",
      projectId: "icmcexperiment1",
      storageBucket: "icmcexperiment1.appspot.com",
      messagingSenderId: "232795895941",
      appId: "1:232795895941:web:d1dbd765303a5b67e7d1ec"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // 匿名ログイン
    let participantId = "";
    signInAnonymously(auth)
      .then((userCredential) => {
        participantId = userCredential.user.uid;
        console.log("匿名ログイン成功:", participantId);
      })
      .catch((error) => console.error("ログインエラー:", error));

    // Canvasと背景画像
    const canvas = document.getElementById("drawCanvas");
    const ctx = canvas.getContext("2d");

    const img = new Image();
    img.src = "stage.png"; // HTMLと同じ階層に配置
    img.onload = () => {
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      enableDrawing(); // 画像読み込み後に描画機能を有効化
    };
    img.onerror = () => console.error("背景画像の読み込みに失敗しました");

    // 描画機能
    function enableDrawing() {
      let drawing = false;

      canvas.addEventListener("mousedown", e => { drawing = true; draw(e); });
      canvas.addEventListener("mouseup", () => drawing = false);
      canvas.addEventListener("mousemove", e => { if(drawing) draw(e); });

      // タッチ対応
      canvas.addEventListener("touchstart", e => { e.preventDefault(); drawing = true; draw(e.touches[0]); });
      canvas.addEventListener("touchmove", e => { e.preventDefault(); if(drawing) draw(e.touches[0]); });
      canvas.addEventListener("touchend", e => { e.preventDefault(); drawing = false; });
    }

    function draw(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      ctx.fillStyle = "rgba(255,0,0,0.7)";
      ctx.beginPath();
      ctx.arc(x, y, 5, 0, Math.PI * 2);
      ctx.fill();
    }

    // 保存
    const saveBtn = document.getElementById("saveBtn");
    const status = document.getElementById("status");

    saveBtn.addEventListener("click", () => {
      if (!participantId) {
        status.textContent = "まだログイン中です。少し待ってください。";
        return;
      }

      const dataURL = canvas.toDataURL("image/png");
      const storageRef = ref(storage, `drawings/${participantId}.png`);

      uploadString(storageRef, dataURL, 'data_url')
        .then(() => status.textContent = "保存しました！")
        .catch((error) => {
          console.error("保存エラー:", error);
          status.textContent = "保存に失敗しました";
        });
    });
  </script>
</body>
</html>
